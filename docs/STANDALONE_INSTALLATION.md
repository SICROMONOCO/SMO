# SMO Standalone Installation Guide

This guide covers installing SMO directly on your host system without Docker containerization.

## Overview

The standalone installation can run SMO with or without InfluxDB:

**With InfluxDB (Full Installation):**
- ✅ Direct host installation (no containers)
- ✅ Automatic systemd service management  
- ✅ Native InfluxDB installation and configuration
- ✅ Time-series data storage for historical analysis
- ✅ Remote access enabled by default
- ✅ Easy backup and maintenance
- ✅ Lower resource overhead

**Without InfluxDB (Minimal Installation):**
- ✅ Simpler setup - no database configuration needed
- ✅ File-based metrics logging only
- ✅ Web dashboard and TUI work normally
- ✅ Lower memory footprint
- ✅ No InfluxDB credential issues

**Note:** Both the web dashboard and TUI read metrics directly from JSON log files. InfluxDB is only needed if you want historical time-series data storage and analysis capabilities.

## Prerequisites

- **Linux Operating System** (Ubuntu, Debian, Fedora, RHEL, CentOS, or Arch Linux)
- **Root/sudo access** (required for system installation)
- **Python 3.8 or later**
- **Internet connection** (for downloading packages)
- **At least 1GB free disk space** (less if skipping InfluxDB)

## Quick Installation

### 1. Clone or download SMO

```bash
# If you have git
git clone https://github.com/SICROMONOCO/SMO.git
cd SMO

# Or download and extract the repository
```

### 2. Run the installation script

```bash
sudo ./setup-standalone.sh
```

The script will:
1. Detect your Linux distribution
2. Install Python dependencies
3. Install and configure InfluxDB
4. Set up SMO in `/opt/smo`
5. Create systemd services
6. Start all services automatically
7. Configure firewall rules (if applicable)

### 3. Access SMO

After installation completes:

- **Web Dashboard**: http://localhost:5000
- **InfluxDB UI**: http://localhost:8086 (if installed)

For remote access, use your server's IP address:
- **Web Dashboard**: http://YOUR_SERVER_IP:5000
- **InfluxDB UI**: http://YOUR_SERVER_IP:8086 (if installed)

## Running Without InfluxDB

If you want to run SMO without InfluxDB (simpler setup, no database configuration needed):

### Option 1: Disable InfluxDB in existing installation

```bash
# Stop InfluxDB service
sudo systemctl stop influxdb
sudo systemctl disable influxdb

# Set InfluxDB as disabled in environment
echo "INFLUXDB_ENABLED=false" | sudo tee -a /opt/smo/.env

# Restart SMO services
sudo systemctl restart smo-agent smo-web
```

### Option 2: Manual installation without InfluxDB

```bash
# Install SMO manually without running setup-standalone.sh
cd /path/to/SMO

# Create directory structure
sudo mkdir -p /opt/smo /var/log/smo
sudo cp -r . /opt/smo/
sudo chown -R $(whoami):$(whoami) /opt/smo /var/log/smo

# Set up Python environment
cd /opt/smo
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# Create .env file with InfluxDB disabled
cat > /opt/smo/.env << EOF
INFLUXDB_ENABLED=false
HOST_MONITOR=true
EOF

# Create systemd services (agent and web only)
# See setup-standalone.sh for service file examples
```

**Benefits of running without InfluxDB:**
- ✅ No database credentials to manage
- ✅ Simpler setup and maintenance
- ✅ Lower memory usage
- ✅ No InfluxDB connection errors
- ✅ Web dashboard and TUI still work normally (reading from JSON logs)

**What you lose:**
- ❌ No historical time-series data storage
- ❌ Cannot query past metrics via InfluxDB
- ❌ InfluxDB UI not available

## Installation Details

### Directory Structure

The standalone installation uses the following directories:

| Directory | Purpose | Owner |
|-----------|---------|-------|
| `/opt/smo` | Application files, Python venv | User who ran installer |
| `/etc/smo` | Configuration files (symlink to /opt/smo/config) | User who ran installer |
| `/var/log/smo` | Application logs | User who ran installer |
| `/var/lib/smo/influxdb` | InfluxDB data storage | influxdb user |

### Systemd Services

Three systemd services are created:

1. **influxdb.service** - InfluxDB database server
2. **smo-agent.service** - SMO metrics collection agent
3. **smo-web.service** - SMO web dashboard

Services start automatically on boot and restart on failure.

### Environment Configuration

Configuration is stored in `/opt/smo/.env`:

**With InfluxDB:**
```bash
INFLUXDB_ENABLED=true  # Enable InfluxDB integration (default)
INFLUXDB_URL=http://localhost:8086
INFLUXDB_TOKEN=<auto-generated>
INFLUXDB_ORG=smo-org
INFLUXDB_BUCKET=smo-metrics
INFLUXDB_ADMIN_USER=admin
INFLUXDB_ADMIN_PASSWORD=<auto-generated>
HOST_MONITOR=true
```

**Without InfluxDB:**
```bash
INFLUXDB_ENABLED=false  # Disable InfluxDB integration
HOST_MONITOR=true
```

**Important:** 
- If using InfluxDB, save your credentials! They are displayed during installation and stored in `/opt/smo/.env`.
- If `INFLUXDB_ENABLED=false`, all other InfluxDB settings are ignored.

## Managing Services

### View Service Status

```bash
# Check all SMO services
sudo systemctl status smo-agent smo-web influxdb

# Check individual service
sudo systemctl status smo-agent
```

### Start/Stop Services

```bash
# Stop all services
sudo systemctl stop smo-agent smo-web influxdb

# Start all services (in correct order)
sudo systemctl start influxdb smo-agent smo-web

# Restart a service
sudo systemctl restart smo-agent
```

### Enable/Disable Auto-start

```bash
# Disable auto-start on boot
sudo systemctl disable smo-agent smo-web

# Re-enable auto-start
sudo systemctl enable smo-agent smo-web
```

### View Logs

```bash
# View agent logs (real-time)
sudo journalctl -u smo-agent -f

# View web dashboard logs
sudo journalctl -u smo-web -f

# View InfluxDB logs
sudo journalctl -u influxdb -f

# View all SMO logs
sudo journalctl -u smo-agent -u smo-web -f

# View last 100 lines
sudo journalctl -u smo-agent -n 100
```

## Using the TUI Dashboard

The TUI (Text User Interface) dashboard runs interactively in your terminal:

```bash
cd /opt/smo
source venv/bin/activate
python3 -m tui.tui_dashboard
```

Press `Ctrl+C` or `q` to exit.

## Remote Access Configuration

### Firewall Configuration

The installation script automatically configures firewall rules if UFW or firewalld is detected. Manual configuration:

**UFW (Ubuntu/Debian):**
```bash
sudo ufw allow 5000/tcp comment 'SMO Web Dashboard'
sudo ufw allow 8086/tcp comment 'InfluxDB'
sudo ufw enable
```

**Firewalld (Fedora/RHEL/CentOS):**
```bash
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --permanent --add-port=8086/tcp
sudo firewall-cmd --reload
```

**iptables (manual):**
```bash
sudo iptables -A INPUT -p tcp --dport 5000 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 8086 -j ACCEPT
sudo iptables-save > /etc/iptables/rules.v4
```

### Cloud/VPS Additional Steps

If running on a cloud provider (AWS, Azure, GCP, etc.), you may also need to:

1. **Configure Security Groups** (AWS) or equivalent to allow inbound traffic on ports 5000 and 8086
2. **Set up reverse proxy** (recommended for production):

**Nginx Example:**
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

3. **Configure SSL/TLS** for secure remote access

## Configuration

### Modifying Settings

Edit the configuration file:

```bash
sudo nano /opt/smo/config/config.yaml
```

After changes, restart the agent:

```bash
sudo systemctl restart smo-agent
```

### Environment Variables

Edit environment file:

```bash
sudo nano /opt/smo/.env
```

After changes, restart services:

```bash
sudo systemctl restart smo-agent smo-web
```

### InfluxDB Configuration

InfluxDB configuration is in `/etc/influxdb/config.toml`. After editing:

```bash
sudo systemctl restart influxdb
```

## Backup and Restore

### Backup SMO Configuration

```bash
# Backup configuration
sudo tar -czf smo-config-backup.tar.gz /opt/smo/config /opt/smo/.env

# Backup InfluxDB data
sudo systemctl stop influxdb
sudo tar -czf influxdb-backup.tar.gz /var/lib/smo/influxdb
sudo systemctl start influxdb
```

### Restore from Backup

```bash
# Restore configuration
sudo tar -xzf smo-config-backup.tar.gz -C /

# Restore InfluxDB data
sudo systemctl stop influxdb
sudo tar -xzf influxdb-backup.tar.gz -C /
sudo systemctl start influxdb
sudo systemctl restart smo-agent smo-web
```

## Updating SMO

To update to a newer version:

```bash
cd /path/to/new/SMO
sudo systemctl stop smo-agent smo-web

# Backup current installation
sudo cp -r /opt/smo /opt/smo.backup

# Copy new files
sudo cp -r *.py /opt/smo/
sudo cp -r metrics /opt/smo/
sudo cp -r tui /opt/smo/

# Update dependencies
cd /opt/smo
source venv/bin/activate
pip install --upgrade -r requirements.txt

# Restart services
sudo systemctl start smo-agent smo-web
```

## Uninstalling

To completely remove SMO:

```bash
cd /path/to/SMO
sudo ./uninstall-standalone.sh
```

The uninstall script will:
1. Stop all SMO services
2. Remove systemd service files
3. Delete SMO directories
4. Optionally remove InfluxDB
5. Optionally remove InfluxDB data

## Troubleshooting

### Services fail to start

**Check logs:**
```bash
sudo journalctl -u smo-agent -n 50
sudo journalctl -u smo-web -n 50
sudo journalctl -u influxdb -n 50
```

**Common issues:**
- InfluxDB not running: `sudo systemctl start influxdb`
- Port already in use: Check with `sudo netstat -tlnp | grep -E '5000|8086'`
- Permission issues: Check file ownership in `/opt/smo`

### InfluxDB credentials not working

If the credentials generated during installation don't work:

**Check if InfluxDB was already initialized:**
```bash
curl http://localhost:8086/api/v2/setup
# If "allowed": false, InfluxDB is already set up
```

**Option 1: Use existing credentials**
If InfluxDB was previously initialized, you need to use the old credentials. Check `/opt/smo/.env` for stored credentials or retrieve them:
```bash
influx auth list
```

**Option 2: Completely reinitialize**
```bash
# Stop all services
sudo systemctl stop smo-agent smo-web influxdb

# Back up existing data (optional)
sudo cp -r /var/lib/smo/influxdb /var/lib/smo/influxdb.backup

# Remove InfluxDB data
sudo rm -rf /var/lib/smo/influxdb/*

# Restart InfluxDB
sudo systemctl start influxdb

# Wait for InfluxDB to be ready
sleep 5

# Re-run setup with your credentials from /opt/smo/.env
source /opt/smo/.env
influx setup \
  --username admin \
  --password "$INFLUXDB_ADMIN_PASSWORD" \
  --org smo-org \
  --bucket smo-metrics \
  --token "$INFLUXDB_TOKEN" \
  --force

# Restart SMO services
sudo systemctl start smo-agent smo-web
```

### Cannot connect to InfluxDB

**Option 1: Disable InfluxDB and use file-based logging only**

If you're having persistent InfluxDB connection issues, you can disable it:

```bash
# Stop InfluxDB
sudo systemctl stop influxdb
sudo systemctl disable influxdb

# Disable InfluxDB in SMO
echo "INFLUXDB_ENABLED=false" | sudo tee -a /opt/smo/.env

# Restart SMO services
sudo systemctl restart smo-agent smo-web

# Verify services are running
sudo systemctl status smo-agent smo-web
```

The web dashboard and TUI will continue to work normally using file-based metrics.

**Option 2: Fix InfluxDB connection**

**Verify InfluxDB is running:**
```bash
sudo systemctl status influxdb
curl http://localhost:8086/health
```

**Check InfluxDB initialization:**
```bash
influx auth list
```

**Test authentication with token:**
```bash
source /opt/smo/.env
curl -H "Authorization: Token $INFLUXDB_TOKEN" \
  http://localhost:8086/api/v2/buckets
# Should return HTTP 200 and list of buckets
```

### Web dashboard shows "No data" or spinning animation

**Quick Fix: The web dashboard now works without InfluxDB!**

The web dashboard has been updated to read metrics directly from log files (like the TUI). If you're having issues:

**Step 1: Check that metrics are being collected**
```bash
# Check if agent is running
sudo systemctl status smo-agent

# Check if metrics log file exists and is being updated
ls -lh /opt/smo/logs/smo_metrics.jsonl
tail -f /opt/smo/logs/smo_metrics.jsonl
```

**Step 2: If metrics are being collected, refresh the web dashboard**
```bash
# Restart web dashboard
sudo systemctl restart smo-web

# Access the dashboard
# http://localhost:5000
```

**Step 3 (Optional): If you don't need InfluxDB, disable it**
```bash
# This will stop InfluxDB-related errors in logs
echo "INFLUXDB_ENABLED=false" | sudo tee -a /opt/smo/.env
sudo systemctl restart smo-agent smo-web
```

**Legacy InfluxDB troubleshooting (if you want to use InfluxDB):**

<details>
<summary>Click to expand InfluxDB troubleshooting steps</summary>

**Step 1: Check environment variables are loaded**
```bash
# View web dashboard logs
sudo journalctl -u smo-web -f

# You should see lines like:
# "Initializing InfluxDB client:"
# "URL: http://localhost:8086"
# "✓ InfluxDB client initialized successfully"
```

**Step 2: Check agent is running and collecting metrics:**
```bash
sudo systemctl status smo-agent
sudo journalctl -u smo-agent -f

# You should see:
# "✓ InfluxDB client initialized successfully"
# Regular metric collection messages
```

**Step 3: Verify data in InfluxDB:**
```bash
source /opt/smo/.env
influx query "from(bucket:\"smo-metrics\") |> range(start:-1h) |> limit(n:10)"

# Should show recent metrics
```

**Step 4: Check web dashboard can query InfluxDB:**
```bash
# Check browser console (F12) for JavaScript errors
# Common errors:
# - "Failed to connect to InfluxDB" - Check credentials in /opt/smo/.env
# - "No metrics data available" - Agent isn't writing data
# - WebSocket errors - Firewall or proxy issues
```

**Step 5: Verify credentials match across services:**
```bash
# All three should use the same token
sudo grep INFLUXDB_TOKEN /opt/smo/.env
# Check what the agent sees:
sudo journalctl -u smo-agent | grep "Token:"
# Check what the web dashboard sees:
sudo journalctl -u smo-web | grep "Token:"
```

**Step 6: Restart services if needed:**
```bash
sudo systemctl restart influxdb
sleep 5
sudo systemctl restart smo-agent smo-web
# Wait 30 seconds and refresh browser
```

</details>

### High memory/CPU usage

**Check resource limits:**
```bash
sudo systemctl status smo-agent
```

**Adjust refresh intervals in config:**
```bash
sudo nano /opt/smo/config/config.yaml
# Increase refresh intervals for less frequent updates
```

### Permission denied errors

**Fix ownership:**
```bash
sudo chown -R $(whoami):$(whoami) /opt/smo
sudo chown -R $(whoami):$(whoami) /var/log/smo
```

## Performance Tuning

### For Low-Resource Systems

Edit `/opt/smo/config/config.yaml`:

```yaml
refresh:
  cpu: 5        # Increase from 2
  memory: 10    # Increase from 5
  disk: 30      # Increase from 10
  network: 10   # Increase from 5
  process: 5    # Increase from 2
```

### For High-Performance Systems

Reduce refresh intervals for more frequent updates:

```yaml
refresh:
  cpu: 1
  memory: 2
  disk: 5
  network: 2
  process: 1
```

## Security Considerations

### Production Deployment

1. **Change default passwords** in `/opt/smo/.env`
2. **Use strong tokens** (64+ character random strings)
3. **Enable HTTPS** with reverse proxy
4. **Restrict firewall** to specific IPs if possible
5. **Regular backups** of configuration and data
6. **Monitor logs** for unusual activity

### Restricting Access

Bind services to localhost only (edit systemd service files):

**smo-web.service:**
```
ExecStart=/opt/smo/venv/bin/uvicorn web_dashboard:app --host 127.0.0.1 --port 5000
```

Then use SSH tunneling for remote access:
```bash
ssh -L 5000:localhost:5000 -L 8086:localhost:8086 user@server
```

## Comparison: Standalone vs Docker

| Feature | Standalone | Docker |
|---------|-----------|--------|
| Installation complexity | Medium | Low |
| Resource overhead | Lower | Higher |
| Isolation | No | Yes |
| Updates | Manual | Rebuild image |
| Backup | Native tools | Volume backups |
| Integration with host | Native | Through volumes |
| Multi-instance | Complex | Easy |
| Portability | OS-specific | Cross-platform |

Choose standalone when:
- ✅ Running on a dedicated server
- ✅ Need lower resource overhead
- ✅ Want native systemd integration
- ✅ Prefer traditional service management

Choose Docker when:
- ✅ Need isolation from host
- ✅ Want easy updates/rollbacks
- ✅ Running multiple instances
- ✅ Deploying across different systems

## Additional Resources

- [Main README](../README.md) - General SMO documentation
- [CONTAINERIZATION.md](../CONTAINERIZATION.md) - Docker setup guide
- [USAGE.md](../USAGE.md) - Application usage guide
- [InfluxDB Documentation](https://docs.influxdata.com/influxdb/v2/)

## Getting Help

If you encounter issues:

1. Check this documentation
2. Review logs: `sudo journalctl -u smo-agent -u smo-web -u influxdb`
3. Check service status: `sudo systemctl status smo-agent smo-web influxdb`
4. Verify configuration: `/opt/smo/.env` and `/opt/smo/config/config.yaml`
5. Open an issue on GitHub with logs and error messages
